# -*- coding: utf-8 -*-
import json
import urllib2
import random
from time import sleep

def link():
    num = 5000
    while(num > 0):
        if num<0:
            print ('sleep')
            sleep(10)
            num = 5000
        spider('121.413967','31.236314',5)
        num = num-1
        print num

def spider(lon,lat,num):
    http_proxy = {'http': '116.28.109.64:808'}
    url = "https://mwx.mobike.com/mobike-api/rent/nearbyBikesInfo.do"
    payload = "?latitude=%s&longitude=%s&errMsg=getMapCenterLocation" % (lat, lon)
    url = url + payload
    headers = {
        'charset': "utf-8",
        'platform': "4",
        "referer": "https://servicewechat.com/wx40f112341ae33edb/1/",
        'content-type': "application/x-www-form-urlencoded",
        'user-agent': "MicroMessenger/6.5.4.1000 NetType/WIFI Language/zh_CN",
        'host': "mwx.mobike.com",
        'connection': "Keep-Alive",
        'accept-encoding': "gzip",
        'cache-control': "no-cache"
    }
    proxy = [
        '222.128.13.94:8081',
        '222.128.13.94:8081',
        '121.232.147.200:9000',
        '218.89.97.127:9000',
        '117.90.252.123:9000',
        '121.232.147.206:9000',
        '121.232.146.12:9000',
        '222.208.66.14:9000',
        '121.232.147.206:9000',
        '121.232.145.93:9000',
        '118.178.227.171:80',
        '121.31.103.138:8123',
        '110.73.34.186:8123',
        '121.31.152.122:8123',
        '116.28.109.64:808',
        '115.213.1.83:8998',
        '60.178.137.158:8081',
        '117.90.3.185:9000',
        '117.90.1.204:9000',
        '110.73.48.146:8123',
        '111.13.7.42:83',
        '118.178.227.171:80',
        '182.42.46.43:808',
        '111.74.56.249:9000',
        '111.74.56.249:9000',
        '122.96.59.105:82',
        '117.90.2.208:9000',
        '121.232.146.149:9000',
        '60.178.13.75:8081',
        '182.129.243.22:9000',
        '110.73.33.147:8123',
        '123.169.84.88:808',
        '120.27.49.85:8090',
        '122.193.14.114:82',
        '121.232.145.104:9000',
        '171.38.36.78:8123',
        '163.125.222.240:8118',
        '114.230.31.225:3128',
        '171.92.4.67:9000',
        '121.232.147.247:9000',
        '121.232.146.148:9000',
        '121.232.144.201:9000',
        '121.232.145.251:9000',
        '110.73.55.150:8123',
        '112.33.7.9:8081',
        '182.141.46.93:9000',
        '210.76.163.216:8118',
        '221.230.7.59:9000',
        '121.232.146.139:9000',
        '121.232.145.43:9000',
        '118.117.139.117:9000',
        '121.232.146.205:9000',
        '121.232.147.112:9000',
        '202.141.161.30:8118',
        '117.90.0.205:9000',
        '121.232.144.156:9000',
        '122.96.59.105:82',
        '122.96.59.106:80',
        '222.208.66.14:9000',
        '111.12.96.188:80',
        '121.31.152.178:8123',
        '59.66.202.98:1080',
        '110.73.4.93:8123',
        '110.73.40.102:8123',
        '118.117.136.82:9000',
        '121.232.145.5:9000',
        '110.73.0.233:8123',
        '111.74.56.247:9000',
        '118.117.137.188:9000',
        '110.73.3.197:8123',
        '117.90.5.166:9000',
        '113.140.25.4:81',
        '115.230.60.199:808',
        '123.169.91.85:808',
        '117.90.7.181:9000',
        '122.193.14.114:82',
        '121.232.144.234:9000',
        '171.215.237.225:9000',
        '121.232.146.50:9000',
        '121.31.101.137:8123',
        '182.129.242.219:9000',
        '182.90.106.23:8123',
        '121.232.144.209:9000',
        '117.90.7.142:9000',
        '121.232.144.158:9000',
        '171.215.226.246:9000',
        '121.232.146.181:9000',
        '117.90.3.61:9000',
        '121.232.147.222:9000',
        '121.232.145.29:9000',
        '111.74.56.244:9000',
        '111.13.7.42:81',
        '117.90.6.233:9000',
        '163.125.251.253:8118',
        '112.33.7.9:8081',
        '121.232.144.113:9000',
        '122.96.59.106:843',
        '110.72.16.89:8123',
        '183.154.215.0:9000',
        '171.92.32.87:9000',
        '182.129.240.160:9000',
        '121.232.194.184:9000',
        '125.72.125.14:808',
        '120.77.255.133:8088',
        '121.232.144.67:9000',
        '121.232.146.15:9000',
        '121.31.101.188:8123',
        '61.232.121.166:8123',
        '117.90.4.70:9000',
        '182.129.249.38:9000',
        '121.232.147.148:9000',
        '218.104.148.157:8080',
        '58.217.255.184:1080',
        '117.90.4.150:9000',
        '121.232.144.41:9000',
        '121.232.147.165:9000',
        '117.90.0.211:9000',
        '117.90.7.246:9000',
        '121.232.147.195:9000',
        '202.141.161.30:8118',
        '117.90.5.200:9000',
        '121.232.146.127:9000',
        '121.232.145.128:9000',
        '110.73.28.60:8123',
        '60.178.169.117:8081',
        '183.240.87.229:8080',
        '111.155.116.229:8123',
        '121.232.146.217:9000',
        '121.232.144.190:9000',
        '121.232.148.17:9000',
        '117.90.1.254:9000',
        '118.117.137.217:9000',
        '163.125.251.49:8118',
        '120.77.206.98:8118',
        '121.232.145.52:9000',
        '121.232.144.105:9000',
        '118.26.183.215:8080',
        '121.232.147.200:9000',
        '171.92.52.2:9000',
        '121.232.144.89:9000',
        '117.90.5.133:9000',
        '60.178.169.106:8081',
        '220.191.14.233:808',
        '118.117.136.55:9000',
        '117.90.2.28:9000',
        '121.232.144.236:9000',
        '121.232.144.237:9000',
        '117.90.0.98:9000',
        '117.90.2.65:9000',
        '121.232.147.56:9000',
        '182.141.42.29:9000',
        '121.232.144.141:9000',
        '121.232.145.28:9000',
        '210.44.213.63:1080',
        '60.178.170.66:8081',
        '121.232.147.96:9000',
        '171.37.170.153:8123',
        '139.196.121.161:80',
        '118.117.138.101:9000',
        '121.232.147.203:9000',
        '111.155.116.207:8123',
        '218.89.97.88:9000',
        '110.73.51.213:8123',
        '121.232.146.236:9000',
        '121.232.147.241:9000',
        '118.117.137.2:9000',
        '121.31.148.28:8123',
        '171.215.227.75:9000',
        '121.232.146.86:9000',
        '111.13.7.42:80',
        '110.73.31.223:8123',
        '121.232.146.161:9000',
        '117.90.4.61:9000',
        '111.155.116.215:8123',
        '123.169.90.147:808',
        '117.90.5.69:9000',
        '121.232.146.192:9000',
        '121.232.147.246:9000',
        '163.125.251.46:8118',
        '121.232.147.145:9000',
        '121.232.144.138:9000',
        '60.178.1.74:8081',
        '180.110.17.213:808',
        '120.83.99.212:808',
        '111.1.52.45:80',
        '61.157.198.66:8080',
        '121.232.146.75:9000',
        '121.232.147.164:9000',
        '121.232.147.56:9000',
        '114.99.21.133:808',
        '121.232.148.31:9000',
        '121.232.146.71:9000',
        '121.232.147.113:9000',
        '101.86.86.101:8118',
        '182.129.241.132:9000',
        '60.178.10.96:8081',
        '121.40.164.232:8118',
        '183.240.87.229:8080',
        '121.232.147.78:9000',
        '122.96.59.104:80',
        '121.232.146.55:9000',
        '114.238.42.105:808',
        '121.232.147.199:9000',
        '125.92.33.20:3128',
        '60.178.3.139:8081',
        '121.31.155.232:8123',
        '121.232.147.156:9000',
        '121.232.147.55:9000',
        '121.15.170.171:8080',
        '121.232.144.249:9000',
        '118.117.137.2:9000',
        '115.46.76.205:8123',
        '171.39.4.208:8123',
        '221.239.81.83:8118',
        '121.232.145.190:9000',
        '115.213.203.188:808',
        '221.192.134.92:8081',
        '125.67.74.248:9000',
        '182.129.240.154:9000',
        '121.232.147.197:9000',
        '171.92.53.59:9000',
        '222.187.20.51:8998',
        '183.207.176.252:1080',
        '110.72.30.1:8123',
        '121.232.145.115:9000',
        '122.96.59.106:81',
        '121.232.144.37:9000',
        '223.86.37.135:8998',
        '122.96.59.106:843',
        '210.76.163.216:8118',
        '210.44.213.63:1080',
        '121.232.148.43:9000',
        '59.49.129.60:8998',
        '49.86.62.100:808',
        '123.206.225.120:8888',
        '60.178.128.19:8081',
        '218.104.148.157:8080',
        '220.176.93.100:9000',
        '182.129.242.241:9000',
        '121.232.148.61:9000',
        '122.112.230.18:8080',
        '121.232.147.250:9000',
        '59.62.6.93:9000',
        '111.155.116.221:8123',
        '121.232.147.28:9000',
        '171.215.241.87:9000',
        '118.117.138.101:9000',
        '60.178.3.2:8081',
        '114.115.218.71:80',
        '114.115.218.143:8118',
        '121.232.144.82:9000',
        '183.147.22.6:9000',
        '202.121.96.33:8086',
        '121.232.147.205:9000',
        '125.117.132.239:9000',
        '125.67.74.248:9000',
        '121.232.145.151:9000',
        '121.232.145.2:9000',
        '139.196.121.161:80',
        '180.119.65.217:3128',
        '222.208.83.160:9000',
        '114.99.21.133:808',
        '121.13.55.162:8118',
        '180.119.65.25:3128',
        '121.31.147.77:8123',
        '122.112.230.18:8080',
        '121.232.147.34:9000',
        '123.169.90.229:808',
        '180.173.109.149:8118',
        '121.232.147.130:9000',
    ]
    temp = random.randint(0, 269)
    http_proxy['http'] = proxy[temp]
    print (proxy[temp])
    proxy = urllib2.ProxyHandler(http_proxy)
    opener = urllib2.build_opener(proxy)
    request = urllib2.Request(url, headers=headers)
    try:
        response = opener.open(request, timeout=1)
        info = response.read()
        print info
        info = json.loads(info)
        bikes = info['object']
        # for bike in bikes:
        #     print bike['distY']
    except Exception as ex:
        num = num-1
        if num < 0:
            print ("die total")
        else:
            print ("die once")
            with open('./baidu.txt','a') as fp:
                fp.write(str(http_proxy['http']+'\n'))
            spider(lon,lat,num)
        pass
    print ('ok')

if __name__ == '__main__':
    link()